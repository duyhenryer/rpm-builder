name: Build RPM Package

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build-rpm:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        cache: false

    - name: Build binaries
      run: |
        echo "ðŸš€ Building binaries..."
        for dir in repo/*/; do
            if [ -d "$dir" ] && [ -f "$dir/main.go" ]; then
                service=$(basename "$dir")
                echo "ðŸ”¨ $service..."
                cd "$dir"
                go mod tidy
                go build -o "$service" main.go
                cd ../..
            fi
        done

    - name: Prepare RPM sources
      run: |
        echo "ðŸ“¦ Preparing sources..."
        mkdir -p rpm/SOURCES
        
        # Copy binaries
        for dir in repo/*/; do
            [ -d "$dir" ] || continue
            service=$(basename "$dir")
            mkdir -p "apps/$service" "rpm/SOURCES/$service"
            [ -f "repo/$service/$service" ] && cp "repo/$service/$service" "apps/$service/"
            [ -f "apps/$service/$service" ] && cp "apps/$service/$service" "rpm/SOURCES/$service/"
        done
        
        # Copy configs and systemd files
        mkdir -p rpm/SOURCES/conf
        cp apps/conf-shared/*.properties rpm/SOURCES/conf/
        for dir in apps/*/; do
            service=$(basename "$dir")
            [ -f "apps/$service/$service.properties" ] && cp "apps/$service/$service.properties" "rpm/SOURCES/$service/"
        done
        cp infra/nginx/micro-platform.conf rpm/SOURCES/
        cp infra/redis/micro-platform-redis.conf rpm/SOURCES/
        cp rpm/files/systemd/* rpm/SOURCES/
        
        # Verify
        echo "Binaries:" && ls rpm/SOURCES/*/

    - name: Build RPM
      run: |
        echo "ðŸ“¦ Building RPM..."
        mkdir -p dist
        docker run --rm \
          -v "${{ github.workspace }}/rpm/SOURCES:/workspace/SOURCES" \
          -v "${{ github.workspace }}/rpm/specs:/workspace/specs" \
          -v "${{ github.workspace }}/dist:/workspace/dist" \
          -w /workspace \
          rockylinux:9 \
          bash -c '
            dnf install -y rpm-build
            rpmbuild -bb --nodeps \
              --define "_sourcedir /workspace/SOURCES" \
              --define "_specdir /workspace/specs" \
              --define "_builddir /workspace/BUILD" \
              --define "_srcrpmdir /workspace/SRPMS" \
              --define "_rpmdir /workspace/RPMS" \
              --define "_buildrootdir /workspace/BUILDROOT" \
              /workspace/specs/micro-platform.spec
            find /workspace/RPMS -name "*.rpm" -exec cp {} /workspace/dist/ \;
          '
        ls -la dist/*.rpm

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: rpm-packages
        path: dist/*.rpm
        retention-days: 30
