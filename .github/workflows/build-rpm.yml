name: Build RPM Package

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build-rpm:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Build Go binaries
      run: |
        echo "ðŸš€ Building Micro Platform binaries..."
        
        # Auto-detect services in repo/ directory
        services=()
        for dir in repo/*/; do
            if [ -d "$dir" ] && [ -f "$dir/main.go" ]; then
                service_name=$(basename "$dir")
                services+=("$service_name")
            fi
        done
        
        if [ ${#services[@]} -eq 0 ]; then
            echo "âŒ Error: No services found in repo/ directory!"
            exit 1
        fi
        
        echo "ðŸ” Found services: ${services[*]}"
        
        # Build each service
        for service in "${services[@]}"; do
            echo "ðŸ”¨ Building $service from repo/$service/..."
            cd "repo/$service"
            go mod tidy
            go build -o "$service" main.go
            cd ../..
            echo "âœ… $service built successfully"
        done

    - name: Copy binaries to apps/
      run: |
        echo "ðŸ“¦ Copying binaries to apps/..."
        
        services=()
        for dir in repo/*/; do
            if [ -d "$dir" ] && [ -f "$dir/main.go" ]; then
                service_name=$(basename "$dir")
                services+=("$service_name")
            fi
        done
        
        for service in "${services[@]}"; do
            echo "ðŸ“¦ Copying $service binary to apps/$service/..."
            mkdir -p "apps/$service"
            if [ -f "repo/$service/$service" ]; then
                cp "repo/$service/$service" "apps/$service/"
            fi
        done

    - name: Prepare RPM SOURCES
      run: |
        echo "ðŸ“¦ Preparing RPM sources..."
        mkdir -p rpm/SOURCES
        
        # Auto-detect services
        services=()
        for dir in repo/*/; do
            if [ -d "$dir" ] && [ -f "$dir/main.go" ]; then
                service_name=$(basename "$dir")
                services+=("$service_name")
            fi
        done
        
        # Copy binaries
        for service in "${services[@]}"; do
            mkdir -p "rpm/SOURCES/$service"
            if [ -f "apps/$service/$service" ]; then
                cp "apps/$service/$service" "rpm/SOURCES/$service/"
            fi
        done
        
        # Copy shared configs
        mkdir -p rpm/SOURCES/conf
        cp apps/conf-shared/*.properties rpm/SOURCES/conf/ 2>/dev/null || true
        chmod 644 rpm/SOURCES/conf/*.properties 2>/dev/null || true
        
        # Copy app-specific configs
        for service in "${services[@]}"; do
            if [ -f "apps/$service/$service.properties" ]; then
                cp "apps/$service/$service.properties" "rpm/SOURCES/$service/"
                chmod 644 "rpm/SOURCES/$service/$service.properties"
            fi
        done
        
        # Copy infrastructure configs
        cp infra/nginx/micro-platform.conf rpm/SOURCES/ 2>/dev/null || true
        cp infra/redis/micro-platform-redis.conf rpm/SOURCES/ 2>/dev/null || true
        
        # Copy systemd service files
        cp rpm/files/systemd/* rpm/SOURCES/ 2>/dev/null || true

    - name: Build RPM package
      id: rpm_build
      uses: naveenrajm7/rpmbuild@master
      with:
        spec_file: "rpm/specs/micro-platform.spec"

    - name: Upload RPM artifacts
      uses: actions/upload-artifact@v4
      with:
        name: rpm-packages
        path: ${{ steps.rpm_build.outputs.rpm_dir_path }}
        retention-days: 30

    - name: Upload Source RPM artifacts
      uses: actions/upload-artifact@v4
      with:
        name: source-rpm
        path: ${{ steps.rpm_build.outputs.source_rpm_path }}
        retention-days: 30
