name: Build RPM Package

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build-rpm:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        cache: false

    - name: Build Go binaries
      run: |
        echo "ðŸš€ Building binaries from repo/..."
        
        # Build all services in repo/
        for dir in repo/*/; do
            if [ -d "$dir" ] && [ -f "$dir/main.go" ]; then
                service=$(basename "$dir")
                echo "ðŸ”¨ Building $service..."
                cd "$dir"
                go mod tidy
                go build -o "$service" main.go
                cd ../..
                echo "âœ… $service built"
            fi
        done

    - name: Copy binaries to apps/
      run: |
        echo "ðŸ“¦ Copying binaries..."
        for dir in repo/*/; do
            if [ -d "$dir" ]; then
                service=$(basename "$dir")
                mkdir -p "apps/$service"
                if [ -f "repo/$service/$service" ]; then
                    cp "repo/$service/$service" "apps/$service/"
                fi
            fi
        done

    - name: Prepare RPM SOURCES
      run: |
        echo "ðŸ“¦ Preparing RPM sources..."
        mkdir -p rpm/SOURCES
        
        # Copy binaries
        for dir in apps/*/; do
            if [ -d "$dir" ]; then
                service=$(basename "$dir")
                mkdir -p "rpm/SOURCES/$service"
                if [ -f "apps/$service/$service" ]; then
                    cp "apps/$service/$service" "rpm/SOURCES/$service/"
                fi
            fi
        done
        
        # Copy configs
        mkdir -p rpm/SOURCES/conf
        cp apps/conf-shared/*.properties rpm/SOURCES/conf/ 2>/dev/null || true
        chmod 644 rpm/SOURCES/conf/*.properties 2>/dev/null || true
        
        for dir in apps/*/; do
            if [ -d "$dir" ]; then
                service=$(basename "$dir")
                if [ -f "apps/$service/$service.properties" ]; then
                    cp "apps/$service/$service.properties" "rpm/SOURCES/$service/"
                    chmod 644 "rpm/SOURCES/$service/$service.properties"
                fi
            fi
        done
        
        # Copy infrastructure and systemd files
        cp infra/nginx/micro-platform.conf rpm/SOURCES/ 2>/dev/null || true
        cp infra/redis/micro-platform-redis.conf rpm/SOURCES/ 2>/dev/null || true
        cp rpm/files/systemd/* rpm/SOURCES/ 2>/dev/null || true

    - name: Build RPM package
      id: rpm_build
      uses: naveenrajm7/rpmbuild@master
      with:
        spec_file: "rpm/specs/micro-platform.spec"

    - name: Upload RPM artifacts
      uses: actions/upload-artifact@v4
      with:
        name: rpm-packages
        path: ${{ steps.rpm_build.outputs.rpm_dir_path }}
        retention-days: 30

    - name: Upload Source RPM artifacts
      uses: actions/upload-artifact@v4
      with:
        name: source-rpm
        path: ${{ steps.rpm_build.outputs.source_rpm_path }}
        retention-days: 30
